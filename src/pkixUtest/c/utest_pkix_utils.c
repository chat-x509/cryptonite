/*
 * Copyright (c) 2016 PrivatBank IT <acsk@privatbank.ua>. All rights reserved.
 * Redistribution and modifications are permitted subject to BSD license.
 */

#include "utest.h"

#include "cert.h"
#include "pkix_utils.h"
#include "signed_data.h"
#include "pkix_errors.h"

static void test_get_encoded_tbs_from_tbs(void)
{
    Certificate_t *cert = cert_alloc();
    ByteArray *decoded = NULL;
    TBSCertificate_t *tbs_cert = NULL;
    ByteArray *exp_tbs = NULL;
    ByteArray *act_tbs = NULL;

    ASSERT_RET_OK(ba_alloc_from_file("src/pkixUtest/resources/acsk_cert.cer", &decoded));
    ASSERT_RET_OK(cert_decode(cert, decoded));
    ASSERT_RET_OK(cert_get_tbs_cert(cert, &tbs_cert));
    ASSERT_RET_OK(asn_encode_ba(&TBSCertificate_desc, tbs_cert, &exp_tbs));

    ASSERT_NOT_NULL(act_tbs = get_encoded_tbs_from_tbs(tbs_cert));
    ASSERT_EQUALS_BA(exp_tbs, act_tbs);

cleanup:

    BA_FREE(decoded, exp_tbs, act_tbs);
    cert_free(cert);
    ASN_FREE(&TBSCertificate_desc, tbs_cert);
}

static void test_get_cert_set_from_cert_array(void)
{
    ByteArray *decoded = NULL;
    ByteArray *cert_ba =
            ba_alloc_from_le_hex_string("30820617308205BFA0030201020214290539EC60662BE804000000710000008D060000300D060B2A862402010101010301013081DD312B3029060355040A0C22D09FD090D0A220D09AD0912022D09FD0A0D098D092D090D0A2D091D090D09DD09A22310F300D060355040B0C06D0A6D0A1D09A3126302406035504030C1DD0A6D0A1D09A2022D09FD0A0D098D092D090D0A2D091D090D09DD09A223114301206035504050C0B55412D3030303030303031310B30090603550406130255413127302506035504070C1ED094D0BDD196D0BFD180D0BED0BFD0B5D182D180D0BED0B2D181D18CD0BA3129302706035504080C20D094D0BDD196D0BFD180D0BED0BFD0B5D182D180D0BED0B2D181D18CD0BAD0B0301E170D3135303131363039313033375A170D3136303131363231353935395A3081BD3111300F060355040A0C08544F562054455354310D300B060355040C0C04426F73733120301E06035504030C174976616E6F7630204976616E204976616E6F76696368303110300E06035504040C074976616E6F763031183016060355042A0C0F4976616E204976616E6F7669636830310C300A06035504050C03313133310B30090603550406130255413117301506035504070C0E446E6570726F706574726F76736B3117301506035504080C0E446E6570726F706574726F76736B3081F23081C9060B2A862402010101010301013081B9307530070202010102010C020100042110BEE3DB6AEA9E1F86578C45C12594FF942394A7D738F9187E6515017294F4CE01022100800000000000000000000000000000006759213AF182E987D3E17714907D470D0421B60FD2D8DCE8A93423C6101BCA91C47A007E6C300B26CD556C9B0E7D20EF292A000440A9D6EB45F13C708280C4967B231F5EADF658EBA4C037291D38D96BF025CA4E17F8E9720DC615B43A28975F0BC1DEA36438B564EA2C179FD0123E6DB8FAC579040324000421C09A8BCBCF12B24B1445D1B9A0AAC38CC201FE0BD116ABF166AEFB86F7169DAC00A38202DC308202D830290603551D0E0422042094369F44E05A0D1B2854F3A982ACB4818FF6D0449D1A9FA34AD4A0D9EDECB5C9302B0603551D23042430228020290539EC60662BE821EE4750BFDA1E15A34E00666B91E18834A50F710B83577E302F0603551D1004283026A011180F32303135303131363039313033375AA111180F32303136303131363231353935395A300E0603551D0F0101FF0404030206C030170603551D250101FF040D300B06092A862402010101030930190603551D200101FF040F300D300B06092A8624020101010202300C0603551D130101FF04023000301E06082B060105050701030101FF040F300D300B06092A862402010101020130520603551D1F044B30493047A045A0438641687474703A2F2F746573742D6163736B2E70726976617462616E6B2E75612F646F776E6C6F61642F63726C732F43412D32393035333945432D46756C6C2E63726C30530603551D2E044C304A3048A046A0448642687474703A2F2F746573742D6163736B2E70726976617462616E6B2E75612F646F776E6C6F61642F63726C732F43412D32393035333945432D44656C74612E63726C30818D06082B06010505070101048180307E303906082B06010505073001862D687474703A2F2F746573742D6163736B2E70726976617462616E6B2E75612F73657276696365732F6F6373702F304106082B060105050730028635687474703A2F2F746573742D6163736B2E70726976617462616E6B2E75612F63612D6365727469666963617465732F43412E703762304806082B0601050507010B043C303A303806082B06010505073003862C687474703A2F2F746573742D6163736B2E70726976617462616E6B2E75612F73657276696365732F7473702F30580603551D090451304F301A060C2A8624020101010B01040201310A13083131313131313131301C060C2A8624020101010B01040101310C130A313131313131313131313013060C2A8624020101010B010407013103130130300D060B2A86240201010101030101034300044096A1414AC98A2478A2D21047EE47CF7FC77BD9D700864DFD2A1AF7E947D14D589A9964B15311A53550B87A9A638518E04AF3EC45EE2BA9F8827C237E7DAE696A");
    SignedData_t *sdata = sdata_alloc();
    CertificateSet_t *certs_set = NULL;
    CertificateSet_t *act_certs_set = NULL;
    const ByteArray *certs[2] = {NULL, NULL};
    certs[0] = cert_ba;
    certs[1] = NULL;

    ASSERT_RET_OK(ba_alloc_from_file("src/pkixUtest/resources/signed_data.dat", &decoded));
    ASSERT_RET_OK(sdata_decode(sdata, decoded));
    ASSERT_RET_OK(sdata_get_certs(sdata, &certs_set));

    ASSERT_RET_OK(get_cert_set_from_cert_array(certs, &act_certs_set));
    ASSERT_EQUALS_ASN(&CertificateSet_desc, certs_set, act_certs_set);

cleanup:

    BA_FREE(decoded, cert_ba);
    sdata_free(sdata);
    ASN_FREE(&CertificateSet_desc, certs_set);
    ASN_FREE(&CertificateSet_desc, act_certs_set);
}

static void test_get_cert_set_by_sid(void)
{
    ByteArray *decoded = NULL;
    SignedData_t *sdata = sdata_alloc();
    CertificateSet_t *certs_set = NULL;
    CertificateSet_t *act_certs_set = NULL;

    ASSERT_RET_OK(ba_alloc_from_file("src/pkixUtest/resources/signed_data.dat", &decoded));
    ASSERT_RET_OK(sdata_decode(sdata, decoded));
    ASSERT_RET_OK(sdata_get_certs(sdata, &certs_set));

    ASSERT_RET_OK(get_cert_set_by_sid(certs_set, &sdata->signerInfos.list.array[0]->sid, &act_certs_set));
    ASSERT_EQUALS_ASN(&CertificateSet_desc, certs_set, act_certs_set);

cleanup:

    ba_free(decoded);
    sdata_free(sdata);
    ASN_FREE(&CertificateSet_desc, certs_set);
    ASN_FREE(&CertificateSet_desc, act_certs_set);
}

static void test_pkix_check_oid(void)
{
    OBJECT_IDENTIFIER_t *oid = NULL;
    bool flag;

    ASSERT_RET_OK(asn_create_oid_from_text("1.1.1", &oid));

    flag = pkix_check_oid_parent(oid, NULL);
    ASSERT_TRUE(flag == false);

    flag = pkix_check_oid_equal(oid, NULL);
    ASSERT_TRUE(flag == false);

cleanup:

    ASN_FREE(&OBJECT_IDENTIFIER_desc, oid);
}

static void test_get_cert_set_by_sid_2(void)
{
    CertificateSet_t *cert_set = NULL;
    SignerIdentifier_t *sid = NULL;
    CertificateSet_t *certs = NULL;

    ASSERT_ASN_ALLOC(sid);

    ASSERT_RET_OK(get_cert_set_by_sid(cert_set, sid, &certs));
    ASSERT_TRUE(certs == NULL);

cleanup:

    ASN_FREE(&CertificateSet_desc, cert_set);
    ASN_FREE(&CertificateSet_desc, certs);
    ASN_FREE(&SignerIdentifier_desc, sid);
}

static void test_get_cert_by_sid_and_usage(void)
{
    CertificateSet_t *cert_set = NULL;
    SignerIdentifier_t *sid = NULL;
    Certificate_t *cert = NULL;

    ASSERT_ASN_ALLOC(sid);

    ASSERT_RET(RET_PKIX_NO_CERTIFICATE, get_cert_by_sid_and_usage(sid, 0, cert_set, &cert));
    ASSERT_TRUE(cert == NULL);

cleanup:

    ASN_FREE(&CertificateSet_desc, cert_set);
    ASN_FREE(&SignerIdentifier_desc, sid);
    cert_free(cert);
}

void utest_pkix_utils(void)
{
    PR("%s\n", __FILE__);

    test_get_encoded_tbs_from_tbs();
    test_get_cert_set_from_cert_array();
    test_get_cert_set_by_sid();
    test_pkix_check_oid();
    test_get_cert_set_by_sid_2();
    test_get_cert_by_sid_and_usage();
}
